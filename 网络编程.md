## RPCåè®®

#### RPCåè®®æ˜¯ä»€ä¹ˆï¼Ÿ

è¿œç¨‹è¿‡ç¨‹è°ƒåº¦

rpcæ˜¯ä¸€ç§è¿œç¨‹è°ƒåº¦çš„æ–¹æ³•ï¼Œè§„åˆ™ï¼ŒåŒ…æ‹¬äº†ä¼ è¾“åè®®å’Œåºåˆ—åŒ–æ–¹æ³•ä¸¤ä¸ªéƒ¨åˆ†

#### RPCçš„æ‰§è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨clientè°ƒç”¨å’Œclient socketå‘é€ä¸­é—´å’ŒæœåŠ¡å™¨ç«¯çš„socketå’Œæ–¹æ³•è°ƒç”¨ä¸­é—´ï¼Œæ·»åŠ client stubå’Œserver stubï¼Œå¯¹è°ƒç”¨çš„è¯·æ±‚è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œåºåˆ—åŒ–æ˜¯å°†è°ƒç”¨çš„ä¿¡æ¯åŒ…æ‹¬æ–¹æ³•åå’Œå‚æ•°åºåˆ—åŒ–æˆé€‚ç”¨äºRPCå‘é€è§£æçš„æ•°æ®æ ¼å¼ã€‚

#### ProtoBufferçš„åºåˆ—åŒ–æ–¹æ³•ï¼š

åœ¨é¡¹ç›®ä¸­å®šä¹‰protoæ–‡ä»¶ï¼Œprotoæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªNaviConf.protoæ–‡ä»¶ï¼Œå®šä¹‰äº†ä¸€äº›é…ç½®ä¿¡æ¯



## TCPåŸºç¡€çŸ¥è¯†

![img](https://static001.geekbang.org/resource/image/0b/64/0ba3f3d04b1466262c02d6f24ee76a64.jpg)

## TCPï¼šå¥—æ¥å­—ä¸ä¸‰æ¬¡æ¡æ‰‹

å»ºç«‹è¿æ¥æ—¶æœåŠ¡å™¨ç«¯çš„bind**ï¼šå°†è‡ªå·±çš„æœåŠ¡èƒ½åŠ›ç»‘å®šåœ¨ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„åœ°å€å’Œç«¯å£ä¸Š**

æœåŠ¡ç«¯é˜»å¡ï¼šbindä¹‹åçš„listenæ“ä½œä¼šå°†socketè½¬åŒ–ä¸ºæœåŠ¡ç«¯socketï¼Œä¹‹å**æœåŠ¡ç«¯ä¼šé˜»å¡åœ¨acceptæ–¹æ³•ä¸Š**

> socketå’ŒæœåŠ¡ç«¯socketæœ‰å•¥åŒºåˆ«ï¼Ÿ

åŸºäºåé¢çš„å­¦ä¹ æˆ‘äº†è§£åˆ°socketåœ¨æœ€å¼€å§‹åˆ›å»ºçš„æ—¶å€™é»˜è®¤ä¸ºä¸€ä¸ªä¸»åŠ¨å¥—æ¥å­—ï¼Œlistenæ“ä½œä¼šå°†ä¸€ä¸ªä¸»åŠ¨å¥—æ¥å­—è½¬åŒ–ä¸ºä¸€ä¸ªè¢«åŠ¨å¥—æ¥å­—ã€‚

æœåŠ¡ç«¯å‡†å¤‡å°±ç»ªåï¼Œå®¢æˆ·ç«¯æµç¨‹å°±æ˜¯ï¼š**åˆå§‹åŒ–socketï¼Œå†æ‰§è¡Œconnectæ–¹æ³•å‘æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£å‘é€å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ã€‚**

#### å¥—æ¥å­—

IPv4åœ°å€é•¿åº¦32ä½ï¼šAF_INET + 16bit ç«¯å£å· + 32 bit IPV4åœ°å€ + å ä½ç¬¦ = å›ºå®š16å­—èŠ‚

IPv6çš„åœ°å€128ä½ï¼šAF_INET6 + 16bit ç«¯å£å· + 32bit æµæ ‡ï¼ˆä¸ç®¡ï¼‰ + 128bit IPV6åœ°å€ + 32 bitèŒƒå›´ID = å›ºå®š28å­—èŠ‚

> ä¸ºä»€ä¹ˆæœ¬åœ°å¥—æ¥å­—ä¸éœ€è¦ç«¯å£å·ï¼Œipv4å’Œipv6å¥—æ¥å­—éœ€è¦ç«¯å£å·å‘¢ï¼Ÿ

æœ¬åœ°ç«¯å£å·æ˜¯**ç”¨äºè®¿é—®æœ¬åœ°çš„æ–‡ä»¶ç³»ç»Ÿ**ï¼Œå¹¶ä¸éœ€è¦ç«¯å£å·ã€‚è€Œipv4å’Œipv6éƒ½æ˜¯éœ€è¦å°†æ•°æ®å‘é€è¿œç¨‹è®¡ç®—æœºçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿œç¨‹è®¡ç®—æœºå¯èƒ½ä¼šæœ‰å¤šä¸ªè¿›ç¨‹åœ¨è¿›è¡Œç›‘å¬ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ç«¯å£å·æ¥åŒºåˆ†ä¸åŒè¿›ç¨‹ã€‚

#### è¿æ¥â€”â€”æœåŠ¡ç«¯

##### 1. åˆ›å»ºå¥—æ¥å­—

`int socket(int domain, int type, int protocol)`

1. domainï¼šipv4ã€ipv6è¿˜æ˜¯æœ¬åœ°å¥—æ¥å­—ç­‰

2. typeï¼š

    a. SOCK_STREAMï¼šå­—èŠ‚æµ TCP

    b. SOCK_DGRAMï¼šæ•°æ®æŠ¥ UDP

    c. SOCK_RAWï¼šåŸå§‹å¥—æ¥å­—

3. protocolä¸€èˆ¬åªè®¾ç½®ä¸º0

##### 2. bind

`bind(int fd, void *addr, socklen_t len)`

```c
int make_socket(uint16_t port) {
    int sock;
    struct sockaddr_in name;
    
    sock = socket(PF_INET, SOCK_STREAM, 0);
    if (sock < 0)
    {
        perror("socket");
        exit(EXIT_FAILURE);
    }
    
    /*bindingè¿‡ç¨‹*/
    name.sin_family = AF_INET;
    name.sin_port = htons(port);
    name.sin_addr.s_addr = htonl(INADDR_ANY);	/*é€šé…åœ°å€*/
    
    
    if (bind(sock, (struct sockaddr*) &name, sizeof(name)) < 0) {
        perror("bind");
        exit(EXIT_FAILURE);
    }
    
    return sock;
}
```

##### 3. listen

æˆ‘ä»¬ä¸€å¼€å§‹åˆ›å»ºçš„æ˜¯ä¸€ä¸ªä¸»åŠ¨å¥—æ¥å­—ï¼Œå¯ä»¥ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼ˆè°ƒç”¨connectå‡½æ•°ï¼‰ï¼Œlistenæ–¹æ³•å¯ä»¥å°†ä¸»åŠ¨å¥—æ¥å­—è½¬åŒ–ä¸ºä¸€ä¸ªè¢«åŠ¨å¥—æ¥å­—ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿè¿™ä¸ªå¥—æ¥å­—æ˜¯ç”¨æ¥æ¥å—è¿æ¥è¯·æ±‚çš„ã€‚

`int listen(int socketfd, int backlog)`

å…¶ä¸­ï¼Œsocketfdè¡¨ç¤ºå¥—æ¥å­—æè¿°ç¬¦ï¼Œç¬¬äºŒä¸ªbacklogæ˜¯æŒ‡å¯ä»¥æ¥æ”¶çš„å¹¶å‘æ•°ç›®ï¼Œè¿™ä¸ªå‚æ•°è¶Šå¤§ï¼Œå¹¶å‘æ•°ç›®ï¼ˆç†è®ºä¸Šï¼‰è¶Šå¤§

##### 4. accept

`int accept(int linstensockfd, struct sockaddr *cliaddr, socklen_t *addrlen)`

acceptå‡½æ•°çš„å‚æ•°listensockfdå°±æ˜¯ä¹‹å‰é€šè¿‡sockå»ºç«‹å¹¶é€šè¿‡listenè½¬åŒ–çš„ç›‘å¬å¥—æ¥å­—ï¼Œè€Œacceptå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯è¿›è¡Œæ•°æ®äº¤äº’çš„å·²è¿æ¥å¥—æ¥å­—

#### è¿æ¥â€”â€”å®¢æˆ·ç«¯

##### 1. åˆ›å»ºå¥—æ¥å­—

##### 2. connect

å®¢æˆ·ç«¯åœ¨æ‰§è¡Œconnectä¹‹å‰æ²¡å¿…è¦éå¾—æ‰§è¡Œbindæ–¹æ³•ï¼Œå› ä¸ºå®¢æˆ·ç«¯çš„å†…æ ¸ä¼šè‡ªåŠ¨é€‰æ‹©æºIPåœ°å€å’Œç«¯å£è¿›è¡Œåˆ›å»º

`int connect(int sockfd, const struct sockaddr * servaddr, socklen_t addrlen)`

æ‰§è¡Œconnectå‡½æ•°ä¼šæ¿€å‘TCPçš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œè¿æ¥æˆåŠŸ/å¤±è´¥åè¿”å›ã€‚

#### TCPçš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹

### TCP TIME_WAIT

<img src="https://static001.geekbang.org/resource/image/f3/e1/f34823ce42a49e4eadaf642a75d14de1.png" alt="img" style="zoom:67%;" />

æ–­å¼€TCPè¿æ¥ï¼šå››æ¬¡æŒ¥æ‰‹

å½“TCPè¿æ¥æƒ³è¦å…³é—­æ—¶ï¼Œä¸»åŠ¨å‘èµ·æ–­å¼€è¿æ¥çš„ä¸»æœº1å‘é€ä¸€ä¸ªFINæŠ¥æ–‡ï¼Œä¸»æœº2ç”±äºåœ¨readå‡½æ•°ä¸­è¯»åˆ°EOFè·å–åˆ°éœ€è¦æ–­å¼€è¿æ¥ï¼Œè¿›å…¥CLOSE_WAITçŠ¶æ€ï¼Œå¹¶å‘é€ä¸€ä¸ªACKåº”ç­”ã€‚ä¸»æœº2readè¯»åˆ°EOFä¹‹åï¼Œé€šçŸ¥åº”ç”¨ç¨‹åºä¸»åŠ¨å…³é—­è¿æ¥ï¼Œå‘é€FINæŠ¥æ–‡ã€‚

ä¸»æœº1æ¥å—åˆ°FINæŠ¥æ–‡åå‘é€ACKåº”ç­”ï¼Œå¹¶è¿›å…¥TIME_WAITçŠ¶æ€

> é—®é¢˜ï¼šä¸»æœº2æ˜¯ä¸æ˜¯åœ¨è¯»åˆ°äº†EOFä¹‹åæ‰çŸ¥é“éœ€è¦æ–­å¼€è¿æ¥çš„æ¶ˆæ¯çš„ï¼Ÿ

##### ä¸ºä»€ä¹ˆè¦æœ‰TIME_WAITï¼Ÿä¸ºä»€ä¹ˆè¦ç­‰å¾…ä¸¤ä¸ªMSLï¼Ÿ

1. æ˜¯ä¸ºäº†ç¡®ä¿è¢«åŠ¨å…³é—­è¿æ¥æ–¹èƒ½å¤Ÿæ­£å¸¸å…³é—­

    2MSLä»ä¸»åŠ¨å‘èµ·è¿æ¥æ–¹å‘é€å‡ºACKåº”ç­”åŒ…å¼€å§‹è®¡æ—¶ï¼ŒACKåœ¨ç½‘ç»œä¸­å­˜æ´»çš„æœ€é•¿æ—¶é—´ä¸º1MSLï¼Œå¦‚æœè¢«åŠ¨æ¥æ”¶æ–¹æ²¡æœ‰æ”¶åˆ°ACKï¼Œä¼šå‘ä¸»åŠ¨æ–¹å‘é€é‡ä¼ è¯·æ±‚ï¼Œè¿™ä¸ªé‡ä¼ è¯·æ±‚åœ¨ç½‘ç»œä¸­çš„å­˜æ´»æ—¶é—´ä¹Ÿæ˜¯1MSLï¼Œæœ€åçš„æƒ…å†µæ˜¯2MSLï¼Œå¦‚æœè¿‡äº†2MSLæ²¡æœ‰æ”¶åˆ°é‡ä¼ æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¡®ä¿è¢«åŠ¨æ–­å¼€è¿æ¥æ–¹èƒ½å¤Ÿæ­£å¸¸å…³é—­ã€‚

2. æ˜¯ä¸ºäº†è®©æ—§è¿æ¥åœ¨ç½‘ç»œä¸­è‡ªç„¶æ¶ˆå¤±

    è€ƒè™‘è¿™æ ·ä¸€ç§åœºæ™¯ï¼šåœ¨åŸè¿æ¥æ²¡æœ‰ç»è¿‡TIME_WAITé˜¶æ®µå°±å…³é—­åï¼Œä¸»æœº1ï¼ˆä¸»åŠ¨æ–¹ï¼‰å†æ¬¡åˆ›å»ºäº†ä¸€ä¸ªä¸åŸè¿æ¥TCPå››å…ƒç»„ï¼ˆæºIPï¼Œç›®æ ‡IPï¼Œæºç«¯å£ï¼Œç›®æ ‡ç«¯å£ï¼‰ç›¸åŒçš„è¿æ¥ï¼Œé‚£ä¹ˆåŸæ¥åœ¨ç½‘ç»œä¸­æ²¡æœ‰ä¼ åˆ°ä¹Ÿæ²¡æœ‰è¢«è‡ªç„¶ä¸¢å¼ƒçš„æ•°æ®åŒ…å°±ä¼šå°†æ–°è¿æ¥çœ‹åšæ˜¯æ—§é“¾æ¥ï¼Œå¯¹æ–°çš„TCPè¿æ¥äº§ç”Ÿå½±å“ã€‚

    > é—®é¢˜ï¼šè¿™ä¸ªæ—¶é—´çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆ2MSLå°±ä¼šè®©æ‰€æœ‰æ•°æ®æŠ¥è‡ªç„¶æ­»äº¡ï¼Ÿ

##### TIME_WAITçš„å±å®³

1. å†…å­˜èµ„æºå ç”¨
2. ç«¯å£å ç”¨

##### å¦‚ä½•ä¼˜åŒ–TIME_WAIT

1. æš´åŠ›å°†ç³»ç»ŸTIME_WAITæ—¶é—´è°ƒå°
2. SO_LINGERï¼šä¿®æ”¹å¥—æ¥å­—é€‰é¡¹ï¼Œä¸å»ºè®®ä½¿ç”¨
3. å®‰å…¨åˆç†çš„æ–¹å¼ï¼šä¿®æ”¹`net.ipv4.tcp_tw_reuse`
    1. åªé€‚ç”¨äºè¿æ¥å‘èµ·æ–¹ï¼ˆC/Sæ¨¡å‹ä¸­çš„å®¢æˆ·ç«¯ï¼‰ï¼›
    2. å¯¹åº”çš„TIME_WAITçŠ¶æ€çš„è¿æ¥åˆ›å»ºæ—¶é—´è¶…è¿‡1ç§’æ‰å¯ä»¥è¢«å¤ç”¨ã€‚



## æ–‡ä»¶è¯»å†™â€”â€”é€šè¿‡socketè¿›è¡Œè¯»å†™

å½“TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹æˆåŠŸä¹‹åï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºæ¯ä¸ªè¿æ¥å»ºç«‹å‘é€ç¼“å†²åŒº

#### write

å‘é€ç¼“å†²åŒºçš„å¤§å°é€šè¿‡å¥—æ¥å­—çš„é€‰é¡¹æ¥è®¾ç½®ï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè°ƒç”¨writeå‡½æ•°çš„æ—¶å€™ï¼Œå®é™…åšçš„äº‹æƒ…å°±æ˜¯**æŠŠæ•°æ®ä»åº”ç”¨ç¨‹åºï¼ˆçš„å†…å­˜ï¼‰ä¸­æ‹·è´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„å‘é€ç¼“å†²åŒºä¸­**ã€‚

`ssize_t write(int socketfd, const void *buffer, size_t size)`

writeæ–¹æ³•å¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œå‘é€ç¼“å†²åŒºè¶³å¤Ÿå®¹çº³éœ€è¦æ‹·è´çš„æ•°æ®ï¼Œå°±æ­£å¸¸æ‹·è´ï¼Œè¿”å›å†™å…¥æ•°æ®å­—èŠ‚çš„å¤§å°

å¦‚æœéœ€è¦å†™å…¥çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œåªèƒ½å†™ä¸€åŠï¼Œæˆ–è€…ç¼“å†²åŒºçš„å¤§å°ä¸å¤Ÿå®¹çº³ï¼Œè¿™æ—¶æ“ä½œç³»ç»Ÿå¹¶ä¸ä¼šè¿”å›æˆ–æŠ¥é”™ï¼Œè€Œæ˜¯é˜»å¡ï¼Œå¹¶è¿›è¡Œä¸€äº›å¤„ç†ã€‚å¤„ç†çš„æ–¹å¼ä¸åŒçš„æ“ä½œç³»ç»Ÿæœ‰æ‰€ä¸åŒã€‚

æ“ä½œç³»ç»Ÿä¼šèªæ˜åœ°ä¸€ç‚¹ç‚¹å°†æ•°æ®ç¼“å†²åŒºçš„æ•°æ®æ‰“åŒ…ï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“å‡ºå»ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“writeæ–¹æ³•è¿”å›çš„æ—¶å€™ï¼Œåªä»£è¡¨éœ€è¦å†™å…¥ç¼“å†²åŒºçš„æ•°æ®å…¨éƒ¨è¢«å†™å…¥è¿›å»ï¼Œå¹¶ä¸ä»£è¡¨ç¼“å†²åŒºçš„æ•°æ®å·²ç»å…¨éƒ¨è¢«å‘å‡ºå»äº†ã€‚

#### read

`ssize_t read(int socketfd, void *buffer, size_t size)`

readæ–¹æ³•çš„å‚æ•°ï¼šsocketfdå¥—æ¥å­—æè¿°ç¬¦ï¼Œbufferç¼“å†²åŒºï¼Œsizeè¯»å–æœ€å¤šå¤šå°‘ä¸ªå­—èŠ‚ã€‚

è¿”å›å€¼å‘Šè¯‰æˆ‘ä»¬å®é™…çš„å­—èŠ‚æ•°ç›®ï¼Œè¿”å›å€¼ä¸º0ä»£è¡¨EOFï¼ˆend-of-fileï¼‰ï¼Œè¿™åœ¨ç½‘ç»œä¸­è¡¨ç¤ºFINåŒ…ï¼Œè¦è¿›è¡Œæ–­å¼€è¿æ¥çš„å¤„ç†ã€‚è¿”å›-1è¡¨ç¤ºå‡ºé”™ï¼ˆé˜»å¡IOä¸­ï¼Œéé˜»å¡IOä¸­æƒ…å†µä¸åŒï¼‰

noticeï¼š

- å¯¹äºwriteæ¥è¯´ï¼Œè¿”å›æˆåŠŸä»…ä»…è¡¨ç¤ºæ•°æ®å†™åˆ°å‘é€ç¼“å†²åŒºæˆåŠŸï¼Œå¹¶ä¸è¡¨ç¤ºå¯¹ç«¯å·²ç»æˆåŠŸæ”¶åˆ°ã€‚
- å¯¹äºreadæ¥è¯´ï¼Œéœ€è¦å¾ªç¯è¯»å–æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦è€ƒè™‘EOFç­‰å¼‚å¸¸æ¡ä»¶ã€‚



## UDP

![img](https://static001.geekbang.org/resource/image/84/30/8416f0055bedce10a3c7d0416cc1f430.png)

UDPå»ºç«‹è¿æ¥å’Œå‘é€æ•°æ®çš„æ–¹å¼å’ŒTCPæœ‰ä¸åŒï¼Œå‘é€æ•°æ®å’Œæ¥æ”¶æ•°æ®åˆ†åˆ«ä½¿ç”¨sendtoå’Œrecvfromè¿›è¡Œ





## IOå¤šè·¯å¤ç”¨

**å¤šè·¯å¤ç”¨ä¸­çš„å¤šè·¯ä¸€èˆ¬æŒ‡çš„æ˜¯å¤šä¸ªç½‘ç»œé“¾æ¥ï¼Œå¤ç”¨æŒ‡çš„æ˜¯ä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹æ¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚**

éœ€è¦è¿›è¡Œå¤„ç†çš„IOäº‹ä»¶æœ‰å¾ˆå¤šç§ï¼š

* æ ‡å‡†è¾“å…¥æ–‡ä»¶æè¿°ç¬¦å‡†å¤‡å¥½å¯ä»¥è¯»
* ç›‘å¬å¥—æ¥å­—å‡†å¤‡å¥½ï¼Œæ–°çš„è¿æ¥å»ºç«‹æˆåŠŸ
* å·²è¿æ¥å¥—æ¥å­—å‡†å¤‡å¥½å¯ä»¥è¯»
* å¦‚æœä¸€ä¸ªI/Oæ—¶é—´ç­‰å¾…è¶…è¿‡10ç§’ï¼Œå‘ç”Ÿè¶…æ—¶äº‹ä»¶

### 1. select

`int select(int maxfd, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout)`

å‚æ•°ï¼š

1. maxfdï¼šè¡¨ç¤ºå¾…æµ‹è¯•çš„æè¿°ç¬¦æ•°ç›®+1
2. è¯»æè¿°ç¬¦é›†åˆã€å†™æè¿°ç¬¦é›†åˆä¸å¼‚å¸¸æè¿°ç¬¦é›†åˆ
3. timeoutï¼šselectå‡½æ•°æ£€æµ‹è¶…æ—¶æ—¶é—´

selectçš„å®é™…ä¾‹å­ä»£ç ï¼š

```c
int main(int argc, char **argv) {
    if (argc != 2) {
        error(1, 0, "usage: select01 ");
    }
    int socket_fd = tcp_client(argv[1], SERV_PORT);

    char recv_line[MAXLINE], send_line[MAXLINE];
    int n;

    fd_set readmask;
    fd_set allreads;
    FD_ZERO(&allreads);		//é€šè¿‡FD_ZEROåˆå§‹åŒ–äº†ä¸€ä¸ªæè¿°ç¬¦é›†åˆ
    FD_SET(0, &allreads);	// å°†ç¬¬0å·æè¿°ç¬¦ï¼ˆå³æ ‡å‡†è¾“å…¥ï¼‰è®¾ç½®ä¸ºå¾…æ£€æµ‹
    FD_SET(socket_fd, &allreads);	// å°†ç¬¬3å·æè¿°ç¬¦ï¼ˆè¿æ¥å¥—æ¥å­—æè¿°ç¬¦ï¼‰è®¾ç½®ä¸ºå¾…æ£€æµ‹

    for (;;) {
        readmask = allreads;	// æ¯æ¬¡æ£€æµ‹ä¸€è½®ä¹‹åï¼Œå°†å¾…æµ‹è¯•çš„æè¿°ç¬¦é›†åˆé‡ç½®
        int rc = select(socket_fd + 1, &readmask, NULL, NULL, NULL);

        if (rc <= 0) {
            error(1, errno, "select failed");
        }

        if (FD_ISSET(socket_fd, &readmask)) {	// ä½¿ç”¨FD_ISSETåˆ¤æ–­å“ªä¸ªæè¿°ç¬¦å¯ä»¥è¯»äº†ï¼Œè¿™é‡Œåˆ¤æ–­æ˜¯socket_fdè¿æ¥å¥—æ¥å­—æè¿°ç¬¦å¯è¯»ï¼Œé‚£ä¹ˆä½¿ç”¨readå‡½æ•°å°†å¥—æ¥å­—æ•°æ®è¯»å‡º
            n = read(socket_fd, recv_line, MAXLINE);
            if (n < 0) {
                error(1, errno, "read error");
            } else if (n == 0) {
                error(1, 0, "server terminated ");
            }
            recv_line[n] = 0;
            fputs(recv_line, stdout);
            fputs("", stdout);
        }

        if (FD_ISSET(STDIN_FILENO, &readmask)) {	// è¿™é‡Œæ˜¯STDIN_FILENOæ ‡å‡†è¾“å…¥æè¿°ç¬¦å¯è¯»ï¼Œé‚£ä¹ˆå°±å°†æ ‡å‡†è¾“å…¥çš„æ•°æ®è¯»å…¥
            if (fgets(send_line, MAXLINE, stdin) != NULL) {
                int i = strlen(send_line);
                if (send_line[i - 1] == '') {
                    send_line[i - 1] = 0;
                }

                printf("now sending %s", send_line);
                size_t rt = write(socket_fd, send_line, strlen(send_line));
                if (rt < 0) {
                    error(1, errno, "write failed ");
                }
                printf("send bytes: %zu ", rt);
            }
        }
    }

}
```

è€Œselectæ£€æµ‹æ˜¯ä»€ä¹ˆæ—¶å€™ä¼šè¿”å›ï¼Œè®¤ä¸ºæŸä¸ªå¥—æ¥å­—æè¿°ç¬¦å¯è¯»å‘¢ï¼Ÿ

1. å¥—æ¥å­—æ¥å—ç¼“å†²åŒºæœ‰æ•°æ®å¯è¯»ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨readå»æ‰§è¡Œè¯»æ“ä½œåˆ™ç»å¯¹ä¸ä¼šè¢«é˜»å¡
2. æ”¶åˆ°äº†FINæ–­å¼€è¿æ¥è¯·æ±‚ï¼Œé‚£ä¹ˆä½¿ç”¨readå‡½æ•°è¿›è¡Œè¯»æ“ä½œï¼Œä¸ä¼šè¢«é˜»å¡
3. é’ˆå¯¹ç›‘å¬å¥—æ¥å­—ï¼Œå¦‚æœæœ‰å·²ç»å®Œæˆçš„è¿æ¥ï¼Œæ­¤æ—¶ä½¿ç”¨acceptå‡½æ•°å»æ‰§è¡Œä¸ä¼šè¢«é˜»å¡ï¼Œå¯ä»¥å¾—åˆ°å®Œæˆè¿æ¥çš„å¥—æ¥å­—
4. å¥—æ¥å­—æœ‰é”™è¯¯å¾…å¤„ç†ï¼Œä½¿ç”¨readè¿›è¡Œè¯»å–è¿”å›-1

æ€»ä¹‹å°±æ˜¯å†…æ ¸é€šçŸ¥å‡½æ•°æœ‰å¥—æ¥å­—å¯ä»¥è¯»ï¼Œä½¿ç”¨readï¼ˆæˆ–acceptï¼‰å‡½æ•°ä¸ä¼šè¢«é˜»å¡æ—¶ï¼Œå°±ä¼šè°ƒç”¨selectå‡½æ•°è¿›è¡Œéå†æŸ¥æ‰¾ã€‚

##### notice

* selectçš„æè¿°ç¬¦åŸºæ•°ï¼ˆéå†é•¿åº¦ï¼‰æ˜¯å½“å‰æœ€å¤§æè¿°ç¬¦+1
* æ¯æ¬¡selectè°ƒç”¨å®Œæˆä¹‹åè¦é‡ç½®å¾…æµ‹è¯•é›†åˆ

> äº†è§£selectã€pollã€epollä¹‹é—´çš„åŒºåˆ«ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§’åº¦å°±æ˜¯æ¯”è¾ƒä»–ä»¬çš„è¾“å…¥å‚æ•°ï¼Œå‚æ•°ä»£è¡¨äº†ä»–ä»¬èƒ½å¤Ÿç›‘æ§å’Œæ“ä½œçš„æ•°æ®ç»“æ„çš„åŒºåˆ«ã€‚å…¶ä¸­ï¼Œselectå‚æ•°ä¸»è¦æœ‰ä¸€ä¸ªmaxfdï¼šå¾…æ£€æµ‹çš„æè¿°ç¬¦æ•°é‡+1ï¼Œéšåæ˜¯ä¸‰ç§æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼šè¯»æè¿°ç¬¦é›†åˆï¼Œå†™æè¿°ç¬¦é›†åˆå’Œå¼‚å¸¸æè¿°ç¬¦é›†åˆã€‚
>
> selecté€šè¿‡å¾ªç¯éå†å¯ä»¥è¯»çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼ŒæŸ¥æ‰¾å¯ä»¥è¯»æ–‡ä»¶æè¿°ç¬¦ç„¶åé€šçŸ¥åº”ç”¨ç¨‹åºæœ‰æ•°æ®å‡†å¤‡å¥½å¯ä»¥è¯»ã€‚
>
> ä¸€ä¸ªæ–‡ä»¶å¯ä»¥è¯»ï¼Œå°±è¯æ˜è°ƒç”¨ä¼šé˜»å¡çš„readå‡½æ•°ï¼ˆæˆ–è€…æ˜¯å»ºç«‹è¿æ¥çš„acceptå‡½æ•°ï¼‰ä¸ä¼šè¢«é˜»å¡ï¼Œä¸»è¦å‡ ç§æƒ…å†µå°±åƒä¸Šé¢å†™çš„ï¼Œå·²è¿æ¥å¥—æ¥å­—æœ‰æ–°çš„æ•°æ®åˆ°è¾¾ï¼Œå·²è¿æ¥å¥—æ¥å­—æ”¶åˆ°äº†FINæ–­å¼€è¿æ¥æ¶ˆæ¯ï¼Œç›‘å¬å¥—æ¥å­—å·²ä¸å®¢æˆ·ç«¯å®Œæˆä¸‰æ¬¡æ¡æ‰‹è¿æ¥ï¼Œä½¿ç”¨acceptæ–¹æ³•ä¸ä¼šè¢«é˜»å¡ï¼Œè¿˜æœ‰å°±æ˜¯å¥—æ¥å­—å‡ºç°é”™è¯¯ä¿¡æ¯å¯è¯»ã€‚

### 2. poll

selectè™½ç„¶å¯ä»¥ä¸€å®šç¨‹åº¦è§£å†³IOè¯»å†™æ—¶çš„é˜»å¡é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿæœ‰å®ƒçš„é—®é¢˜ï¼Œselectçš„æè¿°ç¬¦æ•°ç»„é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„ï¼Œé•¿åº¦ä¸º1024

pollå’Œselectç›¸æ¯”ï¼Œåœ¨å†…æ ¸äº¤äº’çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠæ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°é™åˆ¶ä¸Šåšäº†æ”¹è¿›

`int poll(struct pollfd *fds, unsigned long nfds, int timeout)`

å‚æ•°ï¼š

1. pollfdç»“æ„ä½“ï¼š

    ```c
    struct pollfd {
        int fd;	// æ–‡ä»¶æè¿°ç¬¦fd
        short events;	// æè¿°ç¬¦ä¸Šå¾…æ£€æµ‹çš„äº‹ä»¶ç±»å‹eventsï¼šä¸€ä¸ªevnetså¯ä»¥é€šè¿‡ä½æ“ä½œè¡¨ç¤ºå¤šä¸ªäº‹ä»¶
        short revents;	// pollæ¯æ¬¡æ£€æµ‹å®Œå¾…æ£€æµ‹çš„æè¿°ç¬¦ä¹‹åï¼Œä¸ä¼šå°†æè¿°ç¬¦çš„ç»“æœé‡ç½®ï¼Œè€Œæ˜¯ä¼šå°†ç»“æœä¿ç•™åœ¨reventsä¸­
    }
    ```

eventsçš„ç±»å‹å¤§æ¦‚åˆ†ä¸ºä¸¤ç§ï¼Œå¯è¯»äº‹ä»¶ä¸å¯å†™äº‹ä»¶ï¼Œå¯è¯»ä¸å¯å†™äº‹ä»¶çš„å®šä¹‰ä¸selectä¸­çš„readsetå’Œwritesetå·®ä¸å¤šï¼Œè¡¨ç¤ºå½“å‰å¯ä»¥è¯»å–æ–‡ä»¶æè¿°ç¬¦ä¸­æ•°æ®readæ–¹æ³•ä¸ä¼šè¢«é˜»å¡ï¼Œå†™çš„è¯å¯ä»¥å‘æ–‡ä»¶ç¼“å†²åŒºä¸­å†™æ•°æ®ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚

2. nfdså°±æ˜¯ç”³è¯·æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦çš„ä¸ªæ•°
3. timeoutæ˜¯æ£€æµ‹è¶…æ—¶æ—¶é—´ï¼šå¦‚æœæ˜¯ä¸ªè´Ÿæ•°è¡¨ç¤ºåœ¨äº‹ä»¶å‘ç”Ÿä¹‹å‰ä¼šä¸€ç›´ç­‰å¾…ï¼›å¦‚æœæ˜¯0è¡¨ç¤ºä¸é˜»å¡è¿›ç¨‹ï¼Œç«‹å³è¿”å›ï¼›å¦‚æœæ˜¯>0è¡¨ç¤ºè¶…æ—¶æ—¶é—´

è¿”å›å€¼ï¼š

å½“æœ‰é”™è¯¯å‘ç”Ÿæ—¶ï¼Œè¿”å›-1ï¼Œå¦‚æœåœ¨åˆ¶æŒ‡å®šæ—¶é—´å†…æ— äº‹å‘ç”Ÿï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›æ£€æµ‹åˆ°çš„äº‹ä»¶ä¸ªæ•°

ä¸€ä¸ªåŸºäºpollçš„æœåŠ¡å™¨æ¨¡å‹ï¼š

```c
#define INIT_SIZE 128

int main(int argc, char **argv) {
    int listen_fd, connected_fd;
    int ready_number;
    ssize_t n;
    char buf[MAXLINE];
    struct sockaddr_in client_addr;

    listen_fd = tcp_server_listen(SERV_PORT);	// åˆ›å»ºä¸€ä¸ªç›‘å¬å¥—æ¥å­—ç„¶åç»‘å®šåœ¨æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œè°ƒç”¨tcp_server_listenæ‰§è¡Œ

    //åˆå§‹åŒ–pollfdæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯listen_fdï¼Œå…¶ä½™çš„ç”¨æ¥è®°å½•å°†è¦è¿æ¥çš„connect_fd
    struct pollfd event_set[INIT_SIZE];	// åˆå§‹åŒ–ä¸€ä¸ªpollfdç»“æ„ä½“æ•°ç»„ç±»å‹çš„eventæ£€æµ‹æ•°ç»„ï¼Œé•¿åº¦ä¸ºINIT_SIZE
    event_set[0].fd = listen_fd;	// å°†event_setä¸­ç¬¬ä¸€ä½è®¾ä¸ºç›‘å¬fdï¼Œè¯´æ˜è¿™ä¸€ä½çš„eventç”¨äºç›‘å¬listenå¥—æ¥å­—å®Œæˆçš„äº‹ä»¶
    event_set[0].events = POLLRDNORM;	// å°†ç¬¬ä¸€ä½çš„eventè®¾ç½®ä¸ºä¸€ä¸ªå¯è¯»äº‹ä»¶ï¼ˆå‡è£…æœ‰å¯è¯»äº‹ä»¶ï¼‰

    // å°†eventfdæ•°ç»„ä¸­çš„fdæˆå‘˜å˜é‡å€¼éƒ½è®¾ä¸º-1ï¼Œåœ¨éå†æ—¶pollå‡½æ•°å¯¹äºfdä¸º-1çš„äº‹ä»¶ä¼šè‡ªåŠ¨ç•¥è¿‡ã€‚
    int i;
    for (i = 1; i < INIT_SIZE; i++) {
        event_set[i].fd = -1;
    }

    for (;;) {
        if ((ready_number = poll(event_set, INIT_SIZE, -1)) < 0) {	// åœ¨è¿™ä¸€è¡Œè°ƒç”¨pollå‡½æ•°æ¥æ£€æµ‹äº‹ä»¶setä¸­çš„å¯ä»¥å¤„ç†çš„äº‹ä»¶ï¼Œä¼ å…¥çš„å‚æ•°åŒ…æ‹¬äº‹ä»¶é˜Ÿåˆ—æœ¬èº«ï¼Œäº‹ä»¶é˜Ÿåˆ—é•¿åº¦ï¼ˆå› ä¸ºpollå‡½æ•°ä¼šè‡ªåŠ¨ç•¥è¿‡å€¼ä¸º-1çš„ä½ç½®æ‰€ä»¥ç›´æ¥ä¼ å…¥æ•´ä¸ªé•¿åº¦å°±å¯ä»¥ï¼Œ-1è¡¨ç¤ºæ²¡æœ‰äº‹ä»¶å‘ç”Ÿä¼šä¸€ç›´ç­‰å¾…
            error(1, errno, "poll failed ");
        }

        if (event_set[0].revents & POLLRDNORM) {  // è¿™é‡Œä½¿ç”¨ä½ä¸æ“ä½œæ¥è¿›è¡Œäº‹ä»¶çš„è¯†åˆ«çš„ï¼Œpollå‡½æ•°çš„event_setä¸­ä½¿ç”¨äºŒè¿›åˆ¶ä½è¡¨ç¤ºäº‹ä»¶
            socklen_t client_len = sizeof(client_addr);
            connected_fd = accept(listen_fd, (struct sockaddr *) &client_addr, &client_len);  // ç›‘å¬åˆ°ä¸€ä¸ªlistenè¯·æ±‚å¯è¯»äº‹ä»¶ä¹‹åï¼ŒæœåŠ¡ç«¯æ‰§è¡Œacceptæ–¹æ³•ï¼Œå°†ä¹‹å‰çš„ç›‘å¬å¥—æ¥å­—è½¬åŒ–ä¸ºä¸€ä¸ªå·²è¿æ¥å¥—æ¥å­—ï¼Œè¿™æ—¶å€™å°±éœ€è¦æ–°å»ºæ–°çš„æ£€æµ‹äº‹ä»¶æ¥ç›‘å¬å·²è¿æ¥çš„å¥—æ¥å­—

            //æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥è®°å½•è¯¥è¿æ¥å¥—æ¥å­—çš„ä½ç½®ï¼Œåˆ›å»ºæ–°çš„å¯¹äºå·²è¿æ¥å¥—æ¥å­—çš„æ£€æµ‹
            for (i = 1; i < INIT_SIZE; i++) {
                if (event_set[i].fd < 0) {
                    event_set[i].fd = connected_fd;
                    event_set[i].events = POLLRDNORM;
                    break;
                }
            }

            // å¦‚æœå·²ç»è¾¾åˆ°äº†äº‹ä»¶é˜Ÿåˆ—èƒ½å®¹çº³çš„é•¿åº¦ï¼Œè¯æ˜æœåŠ¡å™¨ç«¯æ— æ³•å¤„ç†è¿™ä¹ˆå¤šå¾—å®¢æˆ·ç«¯è¿æ¥
            if (i == INIT_SIZE) {
                error(1, errno, "can not hold so many clients");
            }
			// å¯¹pollçš„éå†æ£€æµ‹è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå¤„ç†äº†ç›‘å¬å¥—æ¥å­—ä¹‹åï¼Œå¾…å¤„ç†çš„å¥—æ¥å­—ä¸ªæ•°ä¸º0ï¼Œé‚£ä¹ˆè¯´æ˜æœ¬æ¬¡çš„éå†æ£€æµ‹å·²ç»è¾¾åˆ°ç›®çš„ï¼Œå¯ä»¥é€€å‡ºæ‰§è¡Œä¸‹ä¸€æ¬¡
            if (--ready_number <= 0)
                continue;
        }
        for (i = 1; i < INIT_SIZE; i++) {  // æ¥ä¸‹æ¥æ˜¯å¯¹ï¼šæ²¡æœ‰æ£€æµ‹åˆ°ç›‘å¬å¥—æ¥å­—çš„å¯è¯»äº‹ä»¶ï¼ˆæ— äº‹å‘ç”Ÿï¼‰çš„æƒ…å†µè¿›è¡Œå¤„ç†
            int socket_fd;
            if ((socket_fd = event_set[i].fd) < 0)	// å¦‚æœè¯¥äº‹ä»¶æ£€æµ‹æ²¡æœ‰æäº¤æœ‰æ•ˆçš„å¯è¯»äº‹ä»¶ï¼Œé‚£ä¹ˆå°±ç›´æ¥è·³è¿‡æ£€æµ‹ä¸‹ä¸€ä¸ª
                continue;
            if (event_set[i].revents & (POLLRDNORM | POLLERR)) {  // æ£€æµ‹reventçš„äº‹ä»¶ç±»å‹æ˜¯ä¸æ˜¯å¯è¯»äº‹ä»¶æˆ–è€…erroräº‹ä»¶
                if ((n = read(socket_fd, buf, MAXLINE)) > 0) {	// å¦‚æœæœ‰å¯è¯»äº‹ä»¶å°±è¿›è¡Œè¯»æ“ä½œ
                    if (write(socket_fd, buf, n) < 0) {	// ä¹‹åå†™å›ç»™å®¢æˆ·ç«¯
                        error(1, errno, "write error");
                    }
                } else if (n == 0 || errno == ECONNRESET) {	// å¦‚æœè¯»åˆ°EOFæˆ–è€…è¿æ¥é‡ç½®ï¼Œé‚£ä¹ˆéœ€è¦æ‰§è¡Œcloseå‡½æ•°æ–­å¼€è¿æ¥ï¼Œå¹¶å°†è¿æ¥é‡ç½®ä¸º-1ï¼ˆä¸æ£€æµ‹è¿™ä¸€ä½çš„ï¼‰
                    close(socket_fd);
                    event_set[i].fd = -1;
                } else {	// è¯»å–æ•°æ®å¤±è´¥
                    error(1, errno, "read error");
                }
				// å’Œä¹‹å‰ä¸€æ ·æ˜¯éå†ä¼˜åŒ–å¤„ç†
                if (--ready_number <= 0)
                    break;
            }
        }
    }
}

```

> pollæ–¹æ³•æ¥æ”¶çš„å‚æ•°æ˜¯ä¸€ä¸ªpollfdç»“æ„ä½“ï¼Œå’Œnfdsï¼šç”³è¯·æ£€æµ‹çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚
>
> è¿™ä¸ªpollfdç»“æ„ä½“å°†æ–‡ä»¶æè¿°ç¬¦å°è£…èµ·æ¥ï¼Œå…¶ä¸­çš„æ•°æ®å…ƒç´ åŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦fdï¼Œæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶ç±»å‹eventsï¼ˆeventsä½¿ç”¨äºŒè¿›åˆ¶ä½æ¥è¡¨ç¤ºä¸åŒçš„äº‹ä»¶æ˜¯å¦æœ‰å‘ç”Ÿï¼Œåˆ¤æ–­è¯»å–çš„æ—¶å€™ä¹Ÿæ˜¯ä½¿ç”¨äºŒè¿›åˆ¶ä½è¿›è¡Œæ¯”è¾ƒï¼‰ï¼Œrevents
>
> pollä¸selectæœ€å¤§çš„åŒºåˆ«å°±æ˜¯é‡‡ç”¨pollfdç»“æ„ä½“ä¹‹åï¼Œé‡‡ç”¨é“¾è¡¨è¿›è¡Œå­˜å‚¨ï¼Œçªç ´äº†æ£€æµ‹æ•°é‡çš„é™åˆ¶ã€‚
>
> è¿˜æœ‰é—®é¢˜å°±æ˜¯poilfdç»“æ„ä½“ä¹‹åå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šï¼Œæ¯æ¬¡ä»ç”¨æˆ·æ€å°†æ•°æ®æ‹·è´è‡³å†…æ ¸æ€è¿›è¡Œåˆ¤æ–­å¼€é”€å¾ˆå¤§ã€‚

### 3. epoll

epollé€šè¿‡ç›‘æ§æ³¨å†Œçš„å¤šä¸ªæè¿°å­—ï¼Œæ¥è¿›è¡ŒI/Oäº‹ä»¶çš„åˆ†å‘å¤„ç†ï¼Œä¸åŒäºpollçš„æ˜¯ï¼Œepollä¸ä»…æä¾›äº†é»˜è®¤çš„æ¡ä»¶è§¦å‘çš„æ–¹å¼ï¼Œè¿˜æœ‰æ›´å¼ºå¤§çš„è¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼‰æ–¹å¼

epollåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šepoll_create, epoll_ctlå’Œepoll_wait

##### epoll_create

åˆ›å»ºä¸€ä¸ªepollå®ä¾‹ï¼Œç”¨æ¥è°ƒç”¨epoll_ctlå’Œepoll_waitæ–¹æ³•

##### epoll_ctl

`epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);`

ä½¿ç”¨epoll_createåˆ›å»ºäº†epollå®ä¾‹ä¹‹åå¯ä»¥é€šè¿‡è°ƒç”¨epoll_ctlæ¥å¾€è¿™ä¸ªepollå®ä¾‹ä¸­æ·»åŠ æˆ–åˆ é™¤ç›‘æ§çš„äº‹ä»¶ã€‚

å‚æ•°ï¼š

1. epfdï¼šåˆšåˆšä½¿ç”¨epoll_createåˆ›å»ºçš„epollå®ä¾‹

2. op: å¢åŠ è¿˜æ˜¯åˆ é™¤ä¸€ä¸ªç›‘æ§äº‹ä»¶ï¼š

    * EPOLL_CTL_ADD
    * EPOLL_CTL_DEL
    * EPOLL_CTL_MOD

3. fd: éœ€è¦æ“ä½œçš„äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦

4. event: è¡¨ç¤ºæ³¨å†Œçš„äº‹ä»¶çš„ç±»å‹ï¼Œå°†äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦ + äº‹ä»¶ç±»å‹ + å…¶ä»–ä¿¡æ¯ç»„è£…æˆä¸€ä¸ªæ•°æ®ç»“æ„ä¼ å…¥epollå‡½æ•°ä¸­ï¼Œå…·ä½“ç»“æ„å¦‚ä¸‹ï¼š

    ```c
    typedef union epoll_data {
         void        *ptr;
         int          fd;
         uint32_t     u32;
         uint64_t     u64;
     } epoll_data_t;
    
     struct epoll_event {
         uint32_t     events;      /* Epoll events */
         epoll_data_t data;        /* User data variable */
     };
    ```

    å…¶ä¸­ï¼Œäº‹ä»¶ç±»å‹ä¸pollç›¸åŒï¼Œæœ‰ä»¥ä¸‹å‡ ç§ï¼š

    * EPOLLINï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°å­—å¯ä»¥è¯»
    * EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°å­—å¯ä»¥å†™
    * EPOLLRDHUPï¼šè¡¨ç¤ºå¥—æ¥å­—çš„ä¸€æ®µå·²ç»å…³é—­ï¼Œæˆ–è€…åŠå…³é—­
    * EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°å­—å·²ç»è¢«æŒ‚èµ·
    * EPOLLETï¼šè®¾ç½®ä¸ºedge-triggeredæˆ–è€…level-triggered

#### epoll_wait

`int epoll(int epfd, struct epoll_event *event, int maxevents, int timeout)`

epoll_waitå‡½æ•°ç±»ä¼¼äºä¹‹å‰çš„selectå’Œpollå‡½æ•°ï¼Œè°ƒç”¨è€…çš„è¿›ç¨‹è¢«æŒ‚èµ·ï¼ˆè®¿é—®æ—¶ï¼‰ï¼Œå½“å†…æ ¸æœ‰äº‹ä»¶æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚

å‚æ•°ï¼š

1. epfdï¼šepollå®ä¾‹æè¿°å­—

2. ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°ç”±epoll_waitçš„è¿”å›å€¼æ‰€ç¡®å®šï¼Œæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¾…å¤„ç†çš„I/Oäº‹ä»¶ï¼Œå…¶ä¸­eventsè¡¨ç¤ºå…·ä½“çš„äº‹ä»¶ç±»å‹ï¼Œå¯é€‰çš„å€¼å°±æ˜¯ä¸Šé¢ä»‹ç»è¿‡çš„äº”ç§ã€‚

    æ‰€åŒ…å«çš„epoll_eventä¸­çš„dataå€¼å°±æ˜¯åœ¨epoll_ctlä¸­è®¾ç½®çš„dataï¼Œç”¨äºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´è°ƒç”¨æ—¶æ‰€éœ€

3. maxeventï¼šepoll_waitå¯ä»¥è¿”å›çš„æœ€å¤§äº‹ä»¶å€¼

4. epoll_waitçš„è°ƒç”¨è¶…æ—¶æ—¶é—´ï¼Œ-1è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ï¼Œ0è¡¨ç¤ºç«‹å³è¿”å›

epollä»£ç è§£æï¼š

```c
#include "lib/common.h"

#define MAXEVENTS 128

char rot13_char(char c) {
    if ((c >= 'a' && c <= 'm') || (c >= 'A' && c <= 'M'))
        return c + 13;
    else if ((c >= 'n' && c <= 'z') || (c >= 'N' && c <= 'Z'))
        return c - 13;
    else
        return c;
}

int main(int argc, char **argv) {
    int listen_fd, socket_fd;
    int n, i;
    int efd;
    struct epoll_event event;
    struct epoll_event *events;

    listen_fd = tcp_nonblocking_server_listen(SERV_PORT);

    efd = epoll_create1(0);	// åˆ›å»ºä¸€ä¸ªepollå®ä¾‹
    if (efd == -1) {
        error(1, errno, "epoll create failed");
    }

    event.data.fd = listen_fd;	// è®¾ç½®äº‹ä»¶æ£€æµ‹çš„æ˜¯ä¸€ä¸ªç›‘å¬å¥—æ¥å­—æè¿°å­—
    event.events = EPOLLIN | EPOLLET;	// è®¾ç½®æ‰€æ„ŸçŸ¥çš„äº‹ä»¶ç±»å‹ï¼šå¯è¯»äº‹ä»¶ï¼Œå¹¶è®¾ç½®ä¸ºè¾¹ç¼˜è§¦å‘
    if (epoll_ctl(efd, EPOLL_CTL_ADD, listen_fd, &event) == -1) {	// å°†è¯¥äº‹ä»¶æ³¨å†Œåˆ°epollæ£€æµ‹çš„èŒƒå›´å†…
        error(1, errno, "epoll_ctl add listen fd failed");
    }

    /* Buffer where events are returned */
    events = calloc(MAXEVENTS, sizeof(event));	// åˆ›å»ºeventsæ•°ç»„

    while (1) {
        n = epoll_wait(efd, events, MAXEVENTS, -1);	// è°ƒç”¨epoll_waitæ–¹æ³•æ£€æµ‹ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ä»¬
        printf("epoll_wait wakeup");
        for (i = 0; i < n; i++) {
            if ((events[i].events & EPOLLERR) ||
                (events[i].events & EPOLLHUP) ||
                (!(events[i].events & EPOLLIN))) {	// è¿™é‡Œeventsä¸­çš„äº‹ä»¶ç±»å‹éƒ½ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„listen_fdä¼šå‡ºç°çš„äº‹ä»¶ç±»å‹ï¼Œä»£è¡¨epollå‡ºç°äº†é”™è¯¯
                fprintf(stderr, "epoll error");
                close(events[i].data.fd);
                continue;
            } else if (listen_fd == events[i].data.fd) {	// è¿™é‡Œï¼Œeventsä¸­çš„äº‹ä»¶ç±»å‹ç¬¦åˆäº†é¢„æœŸï¼Œå¯è¯»ï¼ˆä»£è¡¨listen_fdå¯ä»¥è¢«è½¬åŒ–ä¸ºå·²è¿æ¥å¥—æ¥å­—ï¼‰
                struct sockaddr_storage ss;
                socklen_t slen = sizeof(ss);
                int fd = accept(listen_fd, (struct sockaddr *) &ss, &slen);	// è°ƒå–acceptå‡½æ•°å°†listen_fdè½¬åŒ–ä¸ºå·²è¿æ¥å¥—æ¥å­—
                if (fd < 0) {
                    error(1, errno, "accept failed");
                } else {
                    make_nonblocking(fd);	// å°†è¿™ä¸ªå·²è¿æ¥å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡ç±»å‹
                    event.data.fd = fd;
                    event.events = EPOLLIN | EPOLLET; //edge-triggered
                    if (epoll_ctl(efd, EPOLL_CTL_ADD, fd, &event) == -1) {	// å†å°†è¿™ä¸ªå·²è¿æ¥å¥—æ¥å­—æ³¨å†Œåˆ°epollæ£€æµ‹äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œæ–¹æ³•æ˜¯é€šè¿‡å°†event_dataä¸­çš„fdå­—æ®µè®¾ç½®ä¸ºæˆ‘ä»¬è¦ç›‘å¬çš„fd
                        error(1, errno, "epoll_ctl add connection fd failed");
                    }
                }
                continue;
            } else {
                /*
                å¤„ç†å·²è¿æ¥å¥—æ¥å­—ä¸Šçš„å¯è¯»äº‹ä»¶ï¼Œè¯»å–å­—èŠ‚æµï¼Œç¼–ç åå†å›åº”ç»™å®¢æˆ·ç«¯
                */
                socket_fd = events[i].data.fd;
                printf("get event on socket fd == %d ", socket_fd);
                while (1) {
                    char buf[512];
                    if ((n = read(socket_fd, buf, sizeof(buf))) < 0) {
                        if (errno != EAGAIN) {
                            error(1, errno, "read error");
                            close(socket_fd);
                        }
                        break;
                    } else if (n == 0) {
                        close(socket_fd);
                        break;
                    } else {
                        for (i = 0; i < n; ++i) {
                            buf[i] = rot13_char(buf[i]);
                        }
                        if (write(socket_fd, buf, n) < 0) {
                            error(1, errno, "write error");
                        }
                    }
                }
            }
        }
    }

    free(events);
    close(listen_fd);
}
```

epollé€šè¿‡æ”¹è¿›çš„æ¥å£è®¾è®¡ï¼Œé¿å…äº†ç”¨æˆ·æ€-å†…æ ¸æ€é¢‘ç¹çš„æ•°æ®æ‹·è´ï¼Œå¤§å¤§æé«˜äº†ç³»ç»Ÿæ€§èƒ½ã€‚

> ğŸ¤”epollå¦‚ä½•é€šè¿‡æ”¹è¿›æ¥å£è®¾è®¡ï¼Œé¿å…äº†ç”¨æˆ·æ€-å†…æ ¸æ€é¢‘ç¹çš„æ•°æ®æ‹·è´ï¼Œå¤§å¤§æé«˜äº†ç³»ç»Ÿæ€§èƒ½å‘¢ï¼Ÿ



## éé˜»å¡IO

#### é˜»å¡ä¸éé˜»å¡çš„åŒºåˆ«

é˜»å¡IOæ˜¯æŒ‡åº”ç”¨ç¨‹åºå‘æ“ä½œç³»ç»Ÿå†…æ ¸è¯·æ±‚æ“ä½œæ—¶ï¼Œä¼šè¢«æŒ‚èµ·ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿå†…æ ¸å¤„ç†æˆåŠŸè¿”å›ä¹‹åæ‰ç»§ç»­æ‰§è¡Œï¼Œåœ¨è¿™æœŸé—´æ“ä½œç³»ç»Ÿå†…æ ¸ä¼šå°†CPUæ—¶é—´åˆ‡æ¢ç»™å…¶ä»–è¿›ç¨‹ã€‚

éé˜»å¡IOæ˜¯æŒ‡åº”ç”¨ç¨‹åºè°ƒç”¨éé˜»å¡IOæ‰§è¡ŒæŸé¡¹æ“ä½œçš„æ—¶å€™ï¼Œå†…æ ¸ç«‹å³è¿”å›ï¼Œä¸ä¼šæŠŠCPUæ—¶é—´ç‰‡åˆ‡æ¢ç»™å…¶ä»–è¿›ç¨‹

#### éé˜»å¡IOä¸å¼‚æ­¥IOçš„åŒºåˆ«



### éé˜»å¡IO

#### è¯»æ“ä½œ

å¦‚æœåœ¨è¯»æ“ä½œæ—¶æ•°æ®ç¼“å†²åŒºæ²¡æœ‰æ•°æ®å¯è¯»ï¼Œéé˜»å¡IOä¼šç«‹å³è¿”å›ï¼Œä¸€èˆ¬è¿”å›çš„æ˜¯EWOULDBLOCKæˆ–è€…EAGAINå‡ºé”™ä¿¡æ¯ï¼Œè€Œè¿™äº›å‡ºé”™ä¿¡æ¯å¹¶ä¸ä¼šå¯¼è‡´è¿”å›é”™è¯¯ï¼Œè€Œæ˜¯é€šè¿‡ä¸æ–­è½®è¯¢è®¿é—®æ˜¯å¦æœ‰æ•°æ®å¯è¯»è¿›è¡Œå¤„ç†ã€‚

#### å†™æ“ä½œ

å¦‚æœå†™æ“ä½œå‡ºé”™ï¼ˆä¸€èˆ¬æ˜¯å‘é€ç¼“å†²åŒºçš„ç©ºé—´å®¹ä¸ä¸‹éœ€è¦å†™çš„å­—èŠ‚æ•°ï¼‰ï¼Œé‚£ä¹ˆéé˜»å¡IOå†™æ“ä½œçš„è¿”å›å€¼ï¼ˆè¿”å›å·²å†™å…¥çš„å­—èŠ‚æ•°ï¼‰å°±æ¯”è¾ƒæœ‰ç”¨äº†ï¼Œå‘Šè¯‰åº”ç”¨ç¨‹åºè¿›ç¨‹å·²ç»å°†ä¼ å…¥æ•°æ®çš„å¤šå°‘å­—èŠ‚æ•°å†™å…¥åˆ°äº†å‘é€ç¼“å†²åŒºã€‚ï¼ˆä½†æ˜¯ä¸€èˆ¬æ¥è¯´é˜»å¡IOçš„å†™æ“ä½œè¿”å›å€¼ä¸€èˆ¬éƒ½ä¼šå’Œè¾“å…¥çš„ä¸€æ ·ï¼Œå› ä¸ºä¸æˆåŠŸå®ƒä¹Ÿä¸ä¼šè¿”å›ï¼‰

**å…³äºreadå’Œwriteè¿˜æœ‰å‡ ä¸ªç»“è®ºï¼Œä½ éœ€è¦æŠŠæ¡ä½ï¼š**

1. **readæ€»æ˜¯åœ¨æ¥æ”¶ç¼“å†²åŒºæœ‰æ•°æ®æ—¶å°±ç«‹å³è¿”å›ï¼Œä¸æ˜¯ç­‰åˆ°åº”ç”¨ç¨‹åºç»™å®šçš„æ•°æ®å……æ»¡æ‰è¿”å›ã€‚å½“æ¥æ”¶ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œé˜»å¡æ¨¡å¼ä¼šç­‰å¾…ï¼Œéé˜»å¡æ¨¡å¼ç«‹å³è¿”å›-1ï¼Œå¹¶æœ‰EWOULDBLOCKæˆ–EAGAINé”™è¯¯ã€‚**
2. **å’Œreadä¸åŒï¼Œé˜»å¡æ¨¡å¼ä¸‹ï¼Œwriteåªæœ‰åœ¨å‘é€ç¼“å†²åŒºè¶³ä»¥å®¹çº³åº”ç”¨ç¨‹åºçš„è¾“å‡ºå­—èŠ‚æ—¶æ‰è¿”å›ï¼›è€Œéé˜»å¡æ¨¡å¼ä¸‹ï¼Œåˆ™æ˜¯èƒ½å†™å…¥å¤šå°‘å°±å†™å…¥å¤šå°‘ï¼Œå¹¶è¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚**
3. **é˜»å¡æ¨¡å¼ä¸‹çš„writeæœ‰ä¸ªç‰¹ä¾‹, å°±æ˜¯å¯¹æ–¹ä¸»åŠ¨å…³é—­äº†å¥—æ¥å­—ï¼Œè¿™ä¸ªæ—¶å€™writeè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œå¹¶é€šè¿‡è¿”å›å€¼å‘Šè¯‰åº”ç”¨ç¨‹åºå®é™…å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå¦‚æœå†æ¬¡å¯¹è¿™æ ·çš„å¥—æ¥å­—è¿›è¡Œwriteæ“ä½œï¼Œå°±ä¼šè¿”å›å¤±è´¥ã€‚å¤±è´¥æ˜¯é€šè¿‡è¿”å›å€¼-1æ¥é€šçŸ¥åˆ°åº”ç”¨ç¨‹åºçš„ã€‚**

#### acceptå‡½æ•°

å½“acceptæ–¹æ³•å’ŒIOå¤šè·¯å¤ç”¨selectã€pollç­‰ä¸€èµ·ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœç›‘å¬å¥—æ¥å­—ä¸Šè§¦å‘äº‹ä»¶ï¼Œé‚£ä¹ˆå°±ä»£è¡¨æœ‰æ–°çš„è¿æ¥å»ºç«‹æˆåŠŸäº†ï¼Œç¨‹åºå¯ä»¥éé˜»å¡åœ°è°ƒç”¨acceptå‡½æ•°ï¼Œå°†ç›‘å¬å¥—æ¥å­—è½¬åŒ–ä¸ºå·²è¿æ¥å¥—æ¥å­—

> ğŸ¤”ä¸ºä»€ä¹ˆç›‘å¬å¥—æ¥å­—ä¸€å®šè¦å®šä¹‰ä¸ºéé˜»å¡çš„ï¼Ÿ



#### connectå‡½æ•°

åœ¨éé˜»å¡æƒ…å†µä¸‹è°ƒç”¨å¥—æ¥å­—çš„connectå‡½æ•°ï¼Œç¨‹åºä¼šç«‹å³è¿”å›ä¸€ä¸ªEINPROGRESSé”™è¯¯ã€‚éšåç¨‹åºä¼šæ­£å¸¸è¿›è¡Œtcpä¸‰æ¬¡æ¡æ‰‹ï¼Œåº”ç”¨ç¨‹åºæ­£å¸¸è¿›è¡Œå„ç§åˆå§‹åŒ–å·¥ä½œã€‚

éšåä¼šä½¿ç”¨selectã€pollç­‰æ–¹æ³•å¯¹è¿æ¥æ˜¯å¦å»ºç«‹è¿›è¡ŒçŠ¶æ€æ£€æµ‹ã€‚



```c
/*
å¯ä»¥é€šè¿‡éé˜»å¡æ–¹å¼ + selectå¤šè·¯å¤ç”¨æ–¹å¼å®ç°ä¸€ä¸ªæœåŠ¡å™¨ç«¯
*/
```



### C10Ké—®é¢˜

å°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨å¦‚ä½•èƒ½æ»¡è¶³10kä¸ªç”¨æˆ·ï¼ˆæŒ‡å¾ˆå¤šï¼‰çš„åŒæ—¶è¿æ¥æœåŠ¡çš„éœ€æ±‚

éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. æ–‡ä»¶å¥æŸ„ä¸ªæ•°ï¼šä¸€èˆ¬å•ä¸ªè¿›ç¨‹æ‰€ç®¡ç†çš„æ–‡ä»¶å¥æŸ„æ˜¯1024ä¸ªï¼Œç°åœ¨çš„linuxç³»ç»Ÿå¯ä»¥ä¿®æ”¹è¿™ä¸ªä¸Šé™
2. ç³»ç»Ÿå†…å­˜é—®é¢˜ï¼šç³»ç»Ÿéœ€è¦ä¸ºæ¯ä¸€ä¸ªè¿æ¥å¥—æ¥å­—å¼€è¾Ÿç¼“å†²åŒºï¼ˆå¯èƒ½åŒ…æ‹¬å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ¯ä¸ªç¼“å†²åŒºçš„å¤§å°è¿˜æœ‰ç¼“å†²åŒºä¸ªæ•°æ¥ç®¡ç†ç¼“å†²åŒº
3. ç½‘ç»œå¸¦å®½ï¼šå¦‚æœæ˜¯1wä¸ªè¿æ¥ï¼Œæ¯ä¸ªè¿æ¥æ¯ç§’ä¼ è¾“1kbçš„æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆå¸¦å®½éœ€è¦10000 * 1kb * 8 = 80Mbps

#### è§£å†³æ€è·¯ï¼š

è§£å†³çš„æ€è·¯ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

1. ç¬¬ä¸€ä¸ªå°±æ˜¯è¦è§£å†³æ“ä½œç³»ç»Ÿç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„äº¤äº’é—®é¢˜ï¼Œå¦‚ä½•æ„ŸçŸ¥I/Oäº‹ä»¶çš„å‘ç”Ÿï¼Œå¦‚ä½•åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸å’Œåº”ç”¨ç¨‹åºä¹‹é—´äº¤äº’æ•°æ®
2. ç¬¬äºŒä¸ªå±‚é¢å°±æ˜¯å¦‚ä½•åˆ†é…æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹å’Œçº¿ç¨‹èµ„æºæ¥æœåŠ¡å¤§é‡çš„è¿æ¥

##### æ–¹å¼1ï¼šé˜»å¡I/O + è¿›ç¨‹

ä¸ºæ¯ä¸€ä¸ªæ–°è¿æ¥forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ¥ç®¡ç†æ–°è¿æ¥çš„æœåŠ¡ã€‚ç”±äºæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å­è¿›ç¨‹è´Ÿè´£å¤„ç†ä¸€ä¸ªè¿æ¥ä¸­çš„æ‰€æœ‰I/Oï¼Œæ‰€ä»¥å³ä½¿æ˜¯é˜»å¡I/Oï¼Œå¤šä¸ªè¿æ¥ä¹‹é—´ä¹Ÿä¸ä¼šäº’ç›¸å½±å“ã€‚

ä½†æ˜¯è¿™ç§æ–¹æ³•çš„æ•ˆç‡ä¸é«˜ï¼Œæ‰©å±•æ€§å·®ï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½å ç”¨ä¸€éƒ¨åˆ†ç³»ç»Ÿèµ„æºå¾ˆéš¾æœ‰å¤§ä½œä¸º

##### æ–¹å¼2ï¼šé˜»å¡I/O + çº¿ç¨‹

ä¸ºæ¯ä¸€ä¸ªæ–°è¿æ¥é€šè¿‡pthread_createåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ¥å¤„ç†è¿æ¥ä¸­çš„æ‰€æœ‰I/Oè¯·æ±‚ã€‚

å› ä¸ºè¿æ¥ä¸æ˜¯éšæ—¶éƒ½éœ€è¦çº¿ç¨‹å“åº”çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹ï¼Œæé«˜æ•ˆç‡

##### æ–¹å¼3ï¼šéé˜»å¡I/O + readiness notification + å•çº¿ç¨‹

ç”±äºæ¯ä¸€ä¸ªè¿æ¥æœ‰I/Oçš„éœ€æ±‚åªæ˜¯ä¸€å°æ®µçš„æ—¶é—´ï¼Œå¹¶ä¸éœ€è¦æ—¶åˆ»éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹æˆ–è€…ä¸€ä¸ªçº¿ç¨‹æ¥ç…§é¡¾å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å•çº¿ç¨‹æ¥è½®è¯¢æ‰€æœ‰æ¥å…¥çš„è¿æ¥ï¼Œåˆ¤æ–­æ¯ä¸ªè¿æ¥æ˜¯å¦æœ‰I/Oéœ€æ±‚ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š

```c
for fd in fdset {
    if (is_readable(fd) == true) {
        handle_read(fd)
    } else if(is_writable(fd) == true) {
        handle_write(fd)
    }
}
```

å¦‚æœæ˜¯è¿™ç§æ–¹å¼ï¼Œå¦‚æœæ¥å…¥çš„è¿æ¥å¾ˆå¤šï¼Œæ¯æ¬¡è½®è¯¢å°±ä¼šé€ æˆå¾ˆå¤šç³»ç»Ÿå¼€é”€ï¼Œé€ æˆæ•ˆç‡å¾ˆä½ï¼Œè¿™æ˜¯éœ€è¦é…åˆå¤šè·¯å¤ç”¨çš„æŠ€æœ¯ï¼Œè®©æ“ä½œç³»ç»Ÿå‘Šè¯‰åº”ç”¨ç¨‹åºå“ªä¸ªå¥—æ¥å­—å¯ä»¥å†™ï¼Œå“ªä¸ªå¥—æ¥å­—å¯ä»¥è¯»ï¼Œæ¯æ¬¡å¯¹æ³¨å†Œäº†éœ€è¦æ£€æµ‹çš„fdè¿›è¡Œæ£€æµ‹ï¼Œæœ‰ä¹‹å‰å­¦åˆ°çš„selectå’Œpollæ–¹æ³•

ä¼ªä»£ç å¦‚ä¸‹ï¼š

```c
while(true) {
    poller.dispatch();
    for fd in registered_fdset {
        if (is_readable(fd) == true) {
            handle_read(fd);
        } else if (is_writable(fd) == true) {
            handle_write(fd);
        }
    }
}
```

è¿˜æ˜¯æ…¢ï¼Œepollå¯ä»¥è®©è½®è¯¢æ£€æµ‹è¿æ¥çš„æ•ˆç‡æ›´å¿«ï¼šåœ¨æ¯æ¬¡dispatchè°ƒç”¨è¿”å›ä¹‹åï¼Œåªè¿”å›æœ‰I/Oäº‹ä»¶æˆ–è€…I/Oäº‹ä»¶å‘ç”Ÿå˜åŒ–çš„å¥—æ¥å­—ï¼š

```c
while(true) {
    poller.dispatch();
    for fd_event in active_event_set {
        if (is_readable_event(fd_event) == true) {
            handle_read(fd_event);
        } else if (is_writable_event(fd_event) == true) {
            handle_write(fd_event);
        }
    }
}
```

##### æ–¹å¼4ï¼šéé˜»å¡I/O + readiness notification + å¤šçº¿ç¨‹

åŸºäºä¹‹å‰çš„åšæ³•ï¼Œå°†å•çº¿ç¨‹æ”¹ä¸ºå¤šçº¿ç¨‹ï¼Œä½¿CPUçš„æ¯ä¸€ä¸ªæ ¸éƒ½ä½œä¸ºä¸€ä¸ªI/Oçš„åˆ†å‘å™¨è¿›è¡ŒI/Oäº‹ä»¶åˆ†å‘

è¢«ç§°ä¸ºä¸»ä»reactoræ¨¡å¼ï¼Œè¿™ä¸ªæ·±äº†

##### æ–¹å¼5ï¼šå¼‚æ­¥I/O + å¤šçº¿ç¨‹

æ“ä½œç³»ç»Ÿæ‰§è¡Œå®Œæˆåå›è°ƒ







# Netty

åœ¨åŸºäºTCPçš„socketç¨‹åºä¸­ï¼Œæˆ‘ä»¬åœ¨ç½‘ç»œç¼–ç¨‹åè®®ä¸­ä¸»è¦éœ€è¦å¤„ç†çš„æ˜¯socketçš„**åˆ›å»ºï¼Œlistenï¼Œacceptï¼Œconnectï¼Œreadï¼Œwrite**å‡ ç§æ“ä½œ

nettyä½¿ç”¨åè®®å’Œé€»è¾‘ç›¸åˆ†ç¦»ï¼Œå…è®¸æˆ‘ä»¬é€šè¿‡æ¥å£æ¥å®ç°ï¼Œå½“åè®®äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†æˆ‘ä»¬çš„é€»è¾‘ï¼Œä¸»è¦åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š

<img src="/Users/lizhigen/Desktop/æˆªå±2021-07-07 ä¸‹åˆ2.24.16.png" alt="æˆªå±2021-07-07 ä¸‹åˆ2.24.16" style="zoom:50%;" />

* Eventloopï¼šä¸»è¦è´Ÿè´£ä»»åŠ¡æ‰§è¡Œä¸äº‹ä»¶çš„æ£€æµ‹
* channelï¼šä¸»è¦è´Ÿè´£åè®®çš„å»ºç«‹ä¸åè®®äº‹ä»¶çš„å¤„ç†
* Bootstrapï¼šä¸»è¦è´Ÿè´£æœåŠ¡çš„å»ºç«‹ä¸å‘å¸ƒ

### Netty.docs

#### 1. Before Getting Started

#### 2. Writing a Discard Server

**ç¬¬ä¸€æ­¥ï¼š**é¦–å…ˆéœ€è¦å®ç°ä¸€ä¸ªhandlerï¼Œç”¨äºå¤„ç†I/Oäº‹ä»¶

```java
package DiscardServer;

import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.ReferenceCountUtil;

/*
handles a server-side channel
 */
public class DiscardServerHandler extends ChannelInboundHandlerAdapter {    // é€šè¿‡ç»§æ‰¿ChannelInboundHandlerAdapterå¹¶é‡å†™å…¶ä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å¤„ç†ä¸åŒäº‹ä»¶çš„é€»è¾‘

    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {    // åœ¨è¿™é‡Œé‡å†™å…³äºæ¥æ”¶æ•°æ®çš„å¤„ç†æ–¹æ³•ï¼Œæ¯æ¬¡readçš„æ—¶å€™ä¼šé‡‡ç”¨é‡å†™çš„æ–¹æ³•ä¸­çš„é€»è¾‘
        // discard the receive data silentlyğŸ˜‚
        ((ByteBuf)msg).release();   // è¿™é‡Œå®ç°discardæ¥æ”¶åˆ°çš„æ¶ˆæ¯
        /*
        ByteBufæ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°å¯¹è±¡ï¼ˆreference-counted objectï¼‰ï¼Œéœ€è¦ä½¿ç”¨releaseæ–¹æ³•è¿›è¡Œæ˜¾ç¤ºåœ°ä¸¢å¼ƒ
        è¯·è®°ä½ï¼Œreleaseæ‰€æœ‰ä¼ é€’ç»™handlerçš„å¼•ç”¨è®¡æ•°å¯¹è±¡æ˜¯handlerçš„è´£ä»»ã€‚
         */
    }
}

```

å¼•ç”¨è®¡æ•°å¯¹è±¡é¡¾åæ€ä¹‰å°±æ˜¯ä½¿ç”¨å¼•ç”¨è®¡æ•°æ–¹æ³•æ¥ç®¡ç†åƒåœ¾å›æ”¶çš„å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è´Ÿè´£å¼•ç”¨è®¡æ•°å¯¹è±¡çš„é‡Šæ”¾

ä¸€èˆ¬å¯¹äºä¼ å…¥æ•°æ®çš„å¤„ç† + å¯¹äºå¼•ç”¨è®¡æ•°å¯¹è±¡çš„release handleråŸºæœ¬å½¢å¼ä¼šå†™æˆè¿™æ ·ï¼š

```java
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    try {
        // Do something with msg
    } finally {
        ReferenceCountUtil.release(msg);
    }
}
```

exceptionCaught()æ–¹æ³•ï¼Œå½“Nettyå‡ºç°exceptionæ—¶è¢«è°ƒç”¨ï¼Œexceptionå¯èƒ½åŒ…æ‹¬I/O erroræˆ–è€…æˆ‘ä»¬å®ç°çš„handleråœ¨å¤„ç†äº‹ä»¶æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¢«æ•è·çš„å¼‚å¸¸éœ€è¦è¢«loggedï¼Œä¸ä¹‹ç›¸å…³çš„channeléœ€è¦è¢«å…³é—­ã€‚ä¹Ÿå¯ä»¥è‡ªå·±å¯¹æŠ›å‡ºå¼‚å¸¸æ—¶çš„çŠ¶å†µè¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ï¼Œå¯èƒ½ä½ æƒ³å‘é€ä¸€ä¸ªresponse message with an error code before closing he connection

```java
@Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        super.exceptionCaught(ctx, cause);
    }
```

**æ¥ä¸‹æ¥ï¼š**ç¼–å†™å¯åŠ¨ä¸€ä¸ªDiscard Serverçš„æ–¹æ³•

```java
package DiscardServer;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

/**
 * Created with IntelliJ IDEA.
 * User: lzg
 * Date: 2021/7/7
 * Time: 3:35 ä¸‹åˆ
 * messge:
 */

/*
Discard server: Discard any income data.
 */
public class DiscardServer {

    private int port;

    public DiscardServer(int port) {
        this.port = port;
    }

    public void run() throws Exception {
        /*
        NioEventLoopGroupæ˜¯ä¸€ç§å¤šçº¿ç¨‹çš„event loopï¼Œç”¨äºå¤„ç†I/Oæ“ä½œ
        Nettyæä¾›äº†å¤šç§å¤šæ ·çš„EventLoopGroupæ¥åº”å¯¹ä¸åŒçš„ä¼ è¾“æƒ…å†µ
        æˆ‘ä»¬è¿™é‡Œå› ä¸ºè¦å®ç°ä¸€ä¸ªserver-sideçš„åº”ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨äº†ä¸¤ä¸ªEventLoopGroup
        ä¸€ä¸ªæ˜¯boss event groupï¼Œæ¥æ”¶ä¼ å…¥çš„è¿æ¥connection
        ä¸€ä¸ªæ˜¯worker event groupï¼Œå¤„ç†bossæ¥å—äº†å¹¶æ³¨å†Œåœ¨è¿æ¥ä¸­çš„connection
        è¿™ä¸ªå¤šçº¿ç¨‹çš„event loopå…·ä½“è¦æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”ä»–ä»¬å¦‚ä½•æ˜ å°„åˆ°åˆ›å»ºçš„channelsä¸Šéƒ½æ˜¯åŸºäºæˆ‘ä»¬å¦‚ä½•å®ç°è¿™ä¸ªeventloopGroup
        ç”šè‡³å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­ç›´æ¥é…ç½®
         */
        EventLoopGroup bossGroup = new NioEventLoopGroup();
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            /*
            serverBootstrapæ˜¯ä¸€ä¸ªhelper classç”¨æ¥åˆ›å»ºä¸€ä¸ªserver
            ä¸ç”¨helperå¯ä»¥ä½¿ç”¨Channelç›´æ¥è¿›è¡Œåˆ›å»ºï¼Œä½†æ˜¯è¿™æ˜¯ä¸€ä¸ªä¹å‘³çš„è¿‡ç¨‹(a tedious process)ä¸å»ºè®®è¿™ä¹ˆå¹²
             */
            ServerBootstrap serverBootstrap = new ServerBootstrap();
            /*
            1. æˆ‘ä»¬ä½¿ç”¨NioServerSocketChannelåˆ›å»ºç”¨äºæ¥æ”¶æ–°ä¼ å…¥è¿æ¥çš„channel
            2. æ¯å½“æœ‰æ–°çš„channelè¢«æ¥å—ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸ªchildHandler
               ChannelInitializerå¸®åŠ©ç”¨æˆ·é…ç½®æ–°çš„Channelï¼šä½ å¯èƒ½å¸Œæœ›å‘æ–°çš„channelçš„ChannelPipelineä¸­æ·»åŠ ä¾‹å¦‚ä¹‹å‰åˆ›å»ºçš„DiscardServerHandler
               å½“åº”ç”¨ç¨‹åºå˜å¾—å¤æ‚ä¹‹åï¼Œä½ å¯èƒ½ä¼šæ·»åŠ æ›´å¤šçš„handlersåˆ°è¿™ä¸ªpipelineä¸­ï¼Œå¹¶ä¸”æœ€ç»ˆå°†è¿™ä¸ªåŒ¿åç±»extract into a top-level class
            3. 4. optionæ˜¯parent groupæ¥å—æ–°çš„connectionæ—¶çš„é€‰é¡¹è®¾ç½®ï¼ŒchildOptionæ˜¯child groupå¯¹parent groupå·²ç»æ¥å—äº†çš„connectionçš„å¤„ç†æ—¶çš„é€‰é¡¹
            å…·ä½“çš„ChannelOptionéœ€è¦çœ‹Nettyçš„ChannelOptionæ–‡æ¡£
             */
            serverBootstrap.group(bossGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)  // 1.
                    .childHandler(new ChannelInitializer<SocketChannel>() { // 2.
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new DiscardServerHandler());
                        }
                    })
                    .option(ChannelOption.SO_BACKLOG, 128)  // 3.
                    .childOption(ChannelOption.SO_KEEPALIVE, true); // 4.

            // bind and start to accept incoming connections
            /*
            æˆ‘çš„æ³¨é‡Šï¼š
            è¿™ä¸ªnettyå¯åŠ¨serverå¥½åƒä¸éœ€è¦å°†socketè½¬åŒ–ä¸ºlistenå¥—æ¥å­—ï¼Œè½¬åŒ–å®Œäº†ä¹‹åç”¨è¿™å¥å°±å¯ä»¥ç›´æ¥æ¥æ”¶æ–°çš„è¿æ¥ï¼Ÿä¸æ‡‚ï¼Œå…ˆè¿™ä¹ˆç”¨ï¼Œå¯èƒ½å’ŒJavaçš„ç½‘ç»œç¼–ç¨‹æœ‰å…³ç³»
            */
            ChannelFuture channelFuture = serverBootstrap.bind(port).sync();
            
            // wait until the server socket is closed
            // in this example, this does not happen, but you can do that to gracefully shut down your server
            channelFuture.channel().closeFuture().sync();
        } finally {
            workerGroup.shutdownGracefully();
            bossGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8080;
        if (args.length >0) {
            port = Integer.parseInt(args[0]);
        }
        new DiscardServer(port).run();
    }
}
```

å¯ä»¥å°†ä¹‹å‰å†™çš„channelRead handlerè¿›è¡Œæ”¹é€ çœ‹çœ‹æˆ‘ä»¬çš„serveræ˜¯å¦æ­£ç¡®æ”¶åˆ°ï¼ˆä¸¢å¼ƒï¼‰äº†ä¿¡æ¯

```JAVA
@Override
public void channelRead(ChannelHandlerContext ctx, Object msg) {
    ByteBuf in = (ByteBuf) msg;
    try {
        while (in.isReadable()) { // å¯ä»¥å°†è¿™ä¸ªä½æ•ˆçš„å¾ªç¯ç›´æ¥æ”¹ä¸ºï¼šSystem.out.println(in.toString(io.netty.util.CharsetUtil.US_ASCII))
            System.out.print((char) in.readByte());
            System.out.flush();
        }
    } finally {
        ReferenceCountUtil.release(msg); // å¯ä»¥å°†è¿™é‡Œæ”¹ä¸ºin.release();
    }
}
```

#### 3. Write an Encho Server

echo serverçš„æ­å»ºå¯åŠ¨å’Œä¹‹å‰discard serverä¸€æ ·ï¼Œä¸åŒç‚¹å°±æ˜¯ä»–ä»¬å¯¹äºå¤„ç†å¯è¯»äº‹ä»¶çš„handlerä¸ä¸€æ ·ï¼Œåªéœ€è¦å°†handlerè¿›è¡Œä¿®æ”¹ï¼š



